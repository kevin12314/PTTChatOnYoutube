
<template>
  <div class="container">
    <div :class="className">
      <div class="col">
        <input
          id="setnewpush"
          v-model.lazy="pushtext"
          class="form-control"
          type="text"
          style="font-size:14px"
          :placeholder="placeholder"
          autocomplete="off"
          :disabled="!getEnableSetNewPush"
          @keyup.13="setPush"
        >
      </div>
      <div class="col-2 px-0">
        <button
          id="setnewpushbtn"
          class="btn ptt-btnoutline w-100 px-2"
          type="button"
          @click.self="setPush()"
        >
          推文
        </button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  inject: ['msg', 'isStream'],
  data () {
    return {
      pushtext: ''
    }
  },
  computed: {
    placeholder: function () {
      if (this.getEnableSetNewPush) return '輸入文字以推文...'
      else return '請到連線設定開啟測試版推文功能'
    },
    className: function () {
      const classes = ['form-row', 'my-2']
      if (!this.isStream) { classes.push('d-none') }
      return classes.join(' ')
    },
    ...Vuex.mapGetters([
      'post',
      'PTTState',
      'getEnableSetNewPush'
    ])
  },
  mounted () {
    this.msg.pushedText = data => this.removePushedText(data)
  },
  methods: {
    setPush: function () {
      const result = /.+/.exec(this.pushtext)
      if (!result) this.$store.dispatch('Alert', { type: 0, msg: '請輸入文字。' })
      else if (this.PTTState < 1) this.$store.dispatch('Alert', { type: 0, msg: 'PTT尚未登入，請先登入。' })
      else if (!this.post.gettedpost) this.$store.dispatch('Alert', { type: 0, msg: '尚未獲取文章，請先獲取文章。' })
      else this.msg.PostMessage('setNewPush', this.pushtext)
    },
    removePushedText (text) {
      if (this.pushtext.indexOf(text) === 0) this.pushtext = this.pushtext.substring(text.length, this.pushtext.length)
      console.log(this.pushtext)
      /* const reg = "(" + text + ")(.*)";
      const result = new RegExp(reg).exec(this.pushtext);
      if (reportMode) console.log("removePushedText", text, this.pushtext, result);
      this.pushtext = result[2]; */
    }
  }
}
</script>

<style lang="scss">
</style>
